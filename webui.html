
<html>

<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.navigate.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.0/jquery-ui.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/4.3.0/min/dropzone.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" />
</head>

<body>
    <div id="dropzone" style="display:none;">
        <form action="/upload" class="dropzone" id="mydz" />
    </div>

    <style>
        .disabledbutton {
            pointer-events: none;
            opacity: 0.4;
        }
        
        #rawgCode {
            margin-bottom: 10px;
        }
        
        .topBar {
            background: white;
            border: 1px solid #c5c5c5;
            margin-bottom: 10px;
        }
        
        .homeIt {
            margin-bottom: 4px;
        }
        
        .jogdial {
            min-width: 30px;
            min-height: 26px;
            padding: 0px;
            border-radius: 0px !important;
            margin-bottom: 1px;
            font-size: 10px;
        }
        
        .jogitem {
            text-align: center;
        }
        
        .controlBox, .controlBoxDisableForPrint {
            border: 2px solid #b3b3b3;
            padding: 0px 0px 10px 0px;
            margin-bottom: 10px;
        }
        
        .controlBoxHeader {
            background: #d9edf7;
            font-size: 20px;
            font-weight: 600;
            text-align: left;
            margin-bottom: 10px;
            border-bottom: 2px solid #b3b3b3;
        }

        .controlSection {
            padding: 0px 10px 10px 0px;
            margin-bottom: 10px;
        }

        .controlSectionHeader {
            font-size: 16px;
            font-weight: 600;
            text-align: left;
            margin-bottom: 10px;
            border-bottom: 2px solid #b3b3b3;
        }
        
        #mainPage {
            margin-top: 10px;
        }
        
        .unkPos {
            color: #ff0000;
        }
        
        .dropzone {
            min-height: 156px;
            padding: 0px;
            background: #e6f9ff;
            border-radius: 10px;
        }
        
        .dropzone .dz-message {
            margin: 1em;
        }
        
        #gCodeLog {
            min-height: 104px;
            max-height: 104px;
            border: 1px solid #b3b3b3;
            margin-bottom: 2px;
            background: #e6f9ff;
            padding: 2px 10px;
            overflow: auto;
            color: #000000;
            font-size: 10px;
        }
        
        span.ui-slider-handle.ui-corner-all.ui-state-default {
            background: #337ab7;
        }
        
        #fanSlider {
            background: #e6f9ff;
        }
    </style>

    <div id="mainPage" class="container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <div class="hero-unit topBar">
                    <div class="col-xs-2">
                        <i class="fa fa-cube"></i> <strong>III P</strong>
                        
                        <br/>
                        v1.0.0.4
                    </div>
                    <div class="col-xs-2" style="text-align: right;">
                            <strong>Print Status: <span id="stat">N/A</span></strong>
                    </div>
                    <div class="col-xs-4">
                        <div style="text-align: center; max-width: 400px; margin:10px auto;">
                            <div class="progress" style="margin-bottom: 10px; height: 30px;border: 1px solid #b3b3b3;">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" id="pgs" style="padding-top: 4px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-2" style="text-align: left;">
                        <strong><span id="pct"></span></strong>
                    </div>
                    <div class="col-xs-2" style="text-align: right;">
                        <button type="button" id="eStop" class="btn btn-outline-light" title="EMERGENCY STOP!!!" style="background-color: transparent;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="red" class="bi bi-sign-stop" viewBox="0 0 16 16">
                                <path d="M3.16 10.08c-.931 0-1.447-.493-1.494-1.132h.653c.065.346.396.583.891.583.524 0 .83-.246.83-.62 0-.303-.203-.467-.637-.572l-.656-.164c-.61-.147-.978-.51-.978-1.078 0-.706.597-1.184 1.444-1.184.853 0 1.386.475 1.436 1.087h-.645c-.064-.32-.352-.542-.797-.542-.472 0-.77.246-.77.6 0 .261.196.437.553.522l.654.161c.673.164 1.06.487 1.06 1.11 0 .736-.574 1.228-1.544 1.228Zm3.427-3.51V10h-.665V6.57H4.753V6h3.006v.568H6.587Z"/>
                                <path fill-rule="evenodd" d="M11.045 7.73v.544c0 1.131-.636 1.805-1.661 1.805-1.026 0-1.664-.674-1.664-1.805V7.73c0-1.136.638-1.807 1.664-1.807s1.66.674 1.66 1.807Zm-.674.547v-.553c0-.827-.422-1.234-.987-1.234-.572 0-.99.407-.99 1.234v.553c0 .83.418 1.237.99 1.237.565 0 .987-.408.987-1.237m1.15-2.276h1.535c.82 0 1.316.55 1.316 1.292 0 .747-.501 1.289-1.321 1.289h-.865V10h-.665zm1.436 2.036c.463 0 .735-.272.735-.744s-.272-.741-.735-.741h-.774v1.485z"/>
                                <path fill-rule="evenodd" d="M4.893 0a.5.5 0 0 0-.353.146L.146 4.54A.5.5 0 0 0 0 4.893v6.214a.5.5 0 0 0 .146.353l4.394 4.394a.5.5 0 0 0 .353.146h6.214a.5.5 0 0 0 .353-.146l4.394-4.394a.5.5 0 0 0 .146-.353V4.893a.5.5 0 0 0-.146-.353L11.46.146A.5.5 0 0 0 11.107 0zM1 5.1 5.1 1h5.8L15 5.1v5.8L10.9 15H5.1L1 10.9z"/>
                              </svg>
                        </button>
                    </div>
                    <div class="clearfix"></div>
                </div>

                <div class="row">
                    <div class="col-md-6">

                        <div class="col-xs-12 controlBox">
                            <div class="col-xs-12 controlBoxHeader"><i class="fa fa-print"></i> Print</div>
                            <div class="col-xs-8">

                            <div class="row">
                                    <div class="col-xs-6">
                                        <button class="btn btn-success btn-block" type="button" id="print"><i class="fa fa-check"></i> Start Print</button>
                                </div>
                                    <div class="col-xs-6">
                                        <button class="btn btn-danger btn-block" type="button" id="cancel"><i class="fa fa-times"></i> Cancel Print</button>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                            <div id="newDropzone" style="margin-top: 10px;"></div>
                        </div>

                            <div class="col-xs-4 controlSection">
                                <div class="col-xs-12 controlSectionHeader" style="margin-top: 10px;">Temperature Control</div>
                                <div class="col-xs-12">
                                    <div class="col-xs-4"></div>
                                    <div class="col-xs-4"></div>
                                    <div class="col-xs-4 text-center" style="align-content: center">

                                        <div style="margin-bottom:10;"><strong>Fan</strong></div>
                                        <div id="fanSlider" style="margin-left: 17px; margin-bottom: 15px;"></div>
                                        <div><strong><span id="fanAmount"style="border: 2px solid #b3b3b3; padding: 6px; border-radius: 2px;">Off</span></strong></div>
                                        
                    </div>
                    </div>

                </div>
                            <div class="clearfix"></div>
                        </div>

                        <div class="col-xs-12 controlBoxDisableForPrint">
                            <div class="col-xs-12 controlBoxHeader" id="movement"><i class="fa fa-arrows"></i> Move</div>
                            <div class="col-xs-8">

                                <div class="col-xs-4 jogitem">
                                    <button class="btn btn-danger homeIt" data-axis="X" data-id="X0"><i class="fa fa-home"></i> X</button>
                                    <br>
                                    <input id="posX" type="text" disabled value="0" placeholder="?" class="unkPos" style="width: 48px;">
                                </div>
                                <div class="col-xs-4 jogitem" style="left: 2px;">
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="50"><i class="fa fa-chevron-up"></i>
                                        <br>50</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="10"><i class="fa fa-chevron-up"></i>
                                        <br>10</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="01"><i class="fa fa-chevron-up"></i>
                                        <br>1</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="0.1"><i class="fa fa-chevron-up"></i>
                                        <br>0.1</button>
                                    <br>
                                </div>
                                <div class="col-xs-4 jogitem">
                                    <button class="btn btn-success homeIt" data-axis="Y" data-id="Y0"><i class="fa fa-home"></i> Y</button>
                                    <br>
                                    <input id="posY" type="text" disabled value="0" placeholder="?" class="unkPos" style="width: 48px;">
                                </div>
                                <div class="clearfix"></div>

                                <div class="col-xs-12 jogitem">
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="-50"><i class="fa fa-chevron-left"></i> 50</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="-10"><i class="fa fa-chevron-left"></i> 10</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="-01"><i class="fa fa-chevron-left"></i> 1</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="-0.1"><i class="fa fa-chevron-left"></i> 0.1</button>
                                    <button class="btn btn-info jogdial homeIt" data-axis="XY" data-id="X0 Y0" style="font-size: 20px;"><i class="fa fa-home"></i></button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="0.1"><i class="fa fa-chevron-right"></i> 0.1</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="01"><i class="fa fa-chevron-right"></i> 1</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="10"><i class="fa fa-chevron-right"></i> 10</button>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="X" data-id="50"><i class="fa fa-chevron-right"></i> 50</button>
                                </div>
                                <div class="clearfix"></div>

                                <div class="col-xs-4 jogitem" style="min-height: 108px;">
                                    <button class="btn btn-info homeIt" data-axis="XYZ" data-id="X0 Y0 Z0" style="position: absolute; bottom: 0; left: 40px;"><i class="fa fa-home"></i> All</button>
                                </div>
                                <div class="col-xs-4 jogitem" style="left: 2px;">
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="-0.1"><i class="fa fa-chevron-down"></i>
                                        <br>0.1</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="-01"><i class="fa fa-chevron-down"></i>
                                        <br>1</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="-10"><i class="fa fa-chevron-down"></i>
                                        <br>10</button>
                                    <br>
                                    <button class="btn btn-info jogdial moveIt" data-speed="F2400" data-axis="Y" data-id="-50"><i class="fa fa-chevron-down"></i>
                                        <br>50</button>
                                    <br>
                                </div>
                                <div class="col-xs-4 jogitem" style="min-height: 108px;">
                                    <button class="btn btn-primary homeIt" data-axis="Z" data-id="Z0" style="position: absolute; bottom: 0; right: 40px;"><i class="fa fa-home"></i> Z</button>
                                    <input id="posZ" type="text" disabled value="0" placeholder="?" class="unkPos" style="width: 48px; position: absolute; bottom: 42px; right: 40px;">
                                </div>
                                <div class="clearfix"></div>
                            </div>

                            <div class="col-xs-2 jogitem">
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="50"><i class="fa fa-chevron-up"></i>
                                    <br>50</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="10"><i class="fa fa-chevron-up"></i>
                                    <br>10</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="01"><i class="fa fa-chevron-up"></i>
                                    <br>1</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="0.1"><i class="fa fa-chevron-up"></i>
                                    <br>0.1</button>
                                <br>
                                <button class="btn btn-primary jogdial homeIt" data-axis="Z" data-id="Z0" style="font-size: 20px;"><i class="fa fa-home"></i></button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="-0.1"><i class="fa fa-chevron-down"></i>
                                    <br>0.1</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="-01"><i class="fa fa-chevron-down"></i>
                                    <br>1</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="-10"><i class="fa fa-chevron-down"></i>
                                    <br>10</button>
                                <br>
                                <button class="btn btn-primary jogdial moveIt" data-speed="F2400" data-axis="Z" data-id="-50"><i class="fa fa-chevron-down"></i>
                                    <br>50</button>
                                <br>
                            </div>

                            <div class="col-xs-2 jogitem">
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F250" data-id="-100"><i class="fa fa-chevron-up"></i>
                                    <br>-100</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F250" data-id="-50"><i class="fa fa-chevron-up"></i>
                                    <br>-50</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F250" data-id="-10"><i class="fa fa-chevron-up"></i>
                                    <br>-10</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F250" data-id="-01"><i class="fa fa-chevron-up"></i>
                                    <br>-1</button>
                                <br>
                                <button class="btn btn-warning jogdial" style="font-size: 20px;"><i class="fa fa-times"></i></button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F100" data-id="01"><i class="fa fa-chevron-down"></i>
                                    <br>1</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F100" data-id="10"><i class="fa fa-chevron-down"></i>
                                    <br>10</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F100" data-id="50"><i class="fa fa-chevron-down"></i>
                                    <br>50</button>
                                <br>
                                <button class="btn btn-warning jogdial moveIt" data-axis="E" data-speed="F100" data-id="100"><i class="fa fa-chevron-down"></i>
                                    <br>100</button>
                                <br>
                            </div>
                        </div>

                        <div class="clearfix"></div>

                    </div>

                    <div class="col-md-6">

                        <div class="col-xs-12 controlBox">
                            <div class="col-xs-12 controlBoxHeader"><i class="fa fa-area-chart"></i> Monitor</div>
                            <div class="col-xs-12">

                        <div class="col-xs-12" style="text-align: center; margin-bottom: 10px;">
                            <strong>Extruder</strong> Temp: <strong><span id="rde" style="border: 3px solid #b3b3b3; padding: 6px; border-radius: 2px; margin-right: 10px;">N/A</span></strong> Target: <strong><span id="rdeTarget" style="border: 3px solid #b3b3b3; padding: 6px; border-radius: 2px; margin-right: 10px;">N/A</span></strong>
                        </div>
                        <div class="clearfix"></div>
                        <div id="tempChart" style="height: 150px;"></div>
                        <div class="clearfix"></div>
                        <div class="col-xs-12" style="text-align: center;">
                            <span class="">
                        <input class="form-control" type="text" id="wre" placeholder="Set Extruder Temp" style="max-width: 200px; display: inline-block;"/>
                        <button class="btn btn-success" id="sete" style="height: 34px;"><i class="fa fa-check"></i></button>
                        <button class="btn btn-danger" id="clre" style="height: 34px;"><i class="fa fa-times"></i></button>
                      </span>
                        </div>
                        <div class="clearfix"></div>

                        <hr>

                        <div class="col-xs-12" style="text-align: center; margin-bottom: 10px;">
                            <strong>Build Platform</strong> Temp: <strong><span id="rdp" style="border: 3px solid #b3b3b3; padding: 6px; border-radius: 2px; margin-right: 10px;">N/A</span></strong> Target: <strong><span id="rdpTarget" style="border: 3px solid #b3b3b3; padding: 6px; border-radius: 2px; margin-right: 10px;">N/A</span></strong>
                        </div>
                        <div class="clearfix"></div>
                        <div id="tempChart2" style="height: 150px;"></div>
                        <div class="clearfix"></div>
                        <div class="col-xs-12" style="text-align: center;">
                            <span class="">
                        <input class="form-control" type="text" id="wrp" placeholder="Set Platform Temp" style="max-width: 200px; display: inline-block;"/>
                        <button class="btn btn-success" id="setp" style="height: 34px;"><i class="fa fa-check"></i></button>
                        <button class="btn btn-danger" id="clrp" style="height: 34px;"><i class="fa fa-times"></i></button>
                      </span>
                        </div>
                        <div class="clearfix"></div>

                    </div>
                        </div>

                        <div class="clearfix"></div>
                    </div>
                </div>

                <div class="row" id="controls">
                    <div class="col-xs-12">
                        <div id="gCodeLog" class=""></div>
                        <div id="rawgCode" class="input-group">
                            <input class="form-control" type="text" name="gcode" id="gcode" placeholder="Send gCode to printer..."><span class="input-group-btn"><button id="sendRAWgCode" class="btn btn-warning"><i class="fa fa-send" aria-hidden="true"></i> Send</button></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $lastStateFetch = null;
        $forceStateState = false;
        $uploadInProgress = false;

        $tooQuick = false;
        $extruderTemp = '0';
        $bedTemp = '0';

        function pad(num, size) {
            var s = "000" + num;
            return s.substr(s.length - size);
        }

        function enableControls(enabled) {
            if (enabled) {
                $("#newDropzone").removeClass('disabledbutton');
                $(".controlBoxDisableForPrint").removeClass('disabledbutton');
                $("#rawgCode").removeClass('disabledbutton');
            } else {
                $("#newDropzone").addClass('disabledbutton');
                $(".controlBoxDisableForPrint").addClass('disabledbutton');
                $("#rawgCode").addClass('disabledbutton');
            }
        }

        function updatePrintingStats(percentComplete) {
            if (percentComplete < 0) {
                $("#stat").text("Idle");
                $("#pgs").css("width", "0%");
            } else {
                $("#stat").text("Printing");
                $("#pgs").css("width", percentComplete + "%");
                $("#pct").html(percentComplete + "%");
            }
        }
        
        function displayConsole(text) {
            $('#gCodeLog').append("<br>" + text);
            gCodeLog.scrollTop = gCodeLog.scrollHeight;
        }

        function invalidateState() {
            setTimeout(function() {
                $forceStateState = true;
            }, 500)
        }

        function sendCommand(cmd) {
            $.ajax({
                url: "set?cmd=" + cmd,
                cache: false
            }).done(function(httpStatus) {
                invalidateState();
                displayConsole("<b>CMD:</b> " + cmd);
                if (httpStatus != 'OK') {
                    displayConsole(" - - - > RESULT:" + httpStatus);
                }
            });
        }

        function sendCode(code, completionCallback, completionCallbackCompleted) {
            $.ajax({
                url: "set?code=" + code,
                cache: false
            }).done(function(httpStatus) {
                invalidateState();

                if (completionCallback) {
                    completionCallback();
                }

                displayConsole(code);
                if (httpStatus != 'OK') {
                    displayConsole(" - - - > RESULT:" + httpStatus);
                }

                if (completionCallbackCompleted) {
                    completionCallbackCompleted();
                }
            });
        }

        function updateState() {
            var current = new Date().getTime();
            var invalidState = $forceStateState || !$lastStateFetch || (current - $lastStateFetch >= 5000);
            if (invalidState && !$uploadInProgress) {
                $forceStateState = false;
                $lastStateFetch = current;

                // fetch state from the printer.
                $.get("inquiry", function(data, status) {
                    console.log(data);
                    
                    $extruderTemp = data.match(/\d+/g)[0];
                    $extruderTarget = data.match(/\d+/g)[1];
                    $bedTemp = data.match(/\d+/g)[2];
                    $bedTarget = data.match(/\d+/g)[3];

                    $("#rde").text($extruderTemp);
                    $("#rdeTarget").text($extruderTarget);
                    $("#rdp").text($bedTemp);
                    $("#rdpTarget").text($bedTarget);
                    
                    var c = data.charAt(data.length - 1);
                    if (c == 'I') {
                        updatePrintingStats(-1);
                        enableControls(true)
                    } else if (c == 'P') {
                        enableControls(false);
                        var percentComplete = data.match(/\d+/g)[4];
                        updatePrintingStats(percentComplete);
                    } else {
                        $("#stat").text(" ");
                    }
                });
            }
        }

        $(document).ready(function() {
            enableControls(false);

            updateState();
            setInterval(updateState, 1000);
        });

        $(document).ready(function() {

            $('#print').click(function() {
                sendCode("M565");
            });

            $('#cancel').click(function() {
                sendCommand('{P:X}');
            });

            $('#eStop').click(function() {
                sendCode("M112\nM999", null, function () {
                    alert('Emergency Stop Sent! You will have to cycle power on the printer to get communications back up.');
                });
            });

            $('#sendRAWgCode').click(function() {
                var gCode2Send = $('#gcode').val();
                if (gCode2Send == '') {
                    alert("You didn't enter anything!");
                    return;
                }

                sendCode(gCode2Send, function() {
                    $('#gcode').val('');
                }, null);
            });

            $("#sete").click(function() {
                var value = pad($("#wre").val(), 3);
                sendCommand('{C:T0' + value + '}');
            });

            $("#clre").click(function() {
                sendCommand("{C:T0000}");
            });

            $("#setp").click(function() {
                var value = pad($("#wrp").val(), 3);
                sendCommand('{C:P' + value + '}');
            });

            $("#clrp").click(function() {
                sendCommand("{C:P000}");
            });
        });

        String.prototype.contains = function(it) {
            return this.indexOf(it) != -1;
        };

        Dropzone.options.mydz = {
            dictDefaultMessage: "Upload GCode here",
            accept: function(file, done) {
                console.log("mydz.accept");
                if (file.name.contains(".g")) {
                    sendCode("M563 S5", function () {
                        console.log("mydz.accept::code M563 S5");
                    done();
                    });
                } else {
                    done("Not a valid GCode file.");
                } 
            },
            init: function() {
                this.on('error', function(file, response) {
                    console.log("mydz.error");
                    $uploadInProgress = false;
                    var errorMessage = response.errorMessage;
                    $(file.previewElement).find('.dz-error-message').text(errorMessage);
                });
                this.on("addedfile", function() {
                    console.log("mydz.addedfile");
                    if (this.files[1] != null) {
                        this.removeFile(this.files[0]);
                    }
                });
                this.on("complete", function() {
                    console.log("mydz.complete");
                    if ($uploadInProgress) {
                        $uploadInProgress = false;
                        displayConsole("Upload complete, ready to print");
                    }
                });
                this.on('sending', function(file, xhr, formData) {
                    console.log("mydz.sending");
                    $uploadInProgress = true;
                    displayConsole("Uploading '" + file.name + "'");
                });
            }
        };

        function setFan($fSpeed) {
            sendCode("M106 S" + $fSpeed);
        }

        $('.homeIt').click(function() {
            var doWhat = $(this).data('id');
            var whatAxis = $(this).data('axis');
            sendCode("G28 " + doWhat, null, function() {
                if (whatAxis == 'XYZ') {
                    $('#posX, #posY, #posZ').val('0');
                    $('#posX, #posY, #posZ').removeClass('unkPos');
                    $axisX = '0';
                    $axisY = '0';
                    $axisZ = '0';
                } else if (whatAxis == 'XY') {
                    $('#posX, #posY').val('0');
                    $('#posX, #posY').removeClass('unkPos');
                    $axisX = '0';
                    $axisY = '0';
                } else {
                    $('#pos' + whatAxis).val('0');
                    $('#pos' + whatAxis).removeClass('unkPos');
                    switch (whatAxis) {
                        case 'X':
                            $axisX = '0';
                            break;
                        case 'Y':
                            $axisY = '0';
                            break;
                        case 'Z':
                            $axisZ = '0';
                            break;
                    }
                }
            });

        });

        $axisX = '0';
        $axisY = '0';
        $axisZ = '0';

        function atMax() {
            $('#movement').html('<span style="color: #ff0000;">MAX Movement!</span>');
            setTimeout(function() {
                $('#movement').html('<i class="fa fa-arrows"></i> Move');
            }, 500);
        }

        $('.moveIt').click(function() {
            if ($tooQuick == true) {
                $('#movement').html('<span style="color: #ff0000;">SLOW DOWN!</span>');
                setTimeout(function() {
                    $('#movement').html('<i class="fa fa-arrows"></i> Move');
                }, 100);
                return;
            }
            var doSpeed = $(this).data('speed');
            var doWhat = $(this).data('id');
            var doWhere = $(this).data('axis');
            var axisVal = $('#pos' + doWhere).val()
            axisVal = +doWhat + +axisVal;

            switch (doWhere) {
                case 'X':
                    $axisX = +$axisX + +doWhat;
                    if ($axisX >= '125') {
                        atMax();
                        $axisX = +$axisX - +doWhat;
                        return;
                    }
                    break;
                case 'Y':
                    $axisY = +$axisY + +doWhat;
                    if ($axisY >= '125') {
                        atMax();
                        $axisY = +$axisY - +doWhat;
                        return;
                    }
                    break;
                case 'Z':
                    $axisZ = +$axisZ + +doWhat;
                    if ($axisZ >= '125') {
                        atMax();
                        $axisZ = +$axisZ - +doWhat;
                        return;
                    }
                    break;
                default:
            }

            $tooQuick = true;
            sendCode("G91");
            sendCode("G1 " + doSpeed + ' ' + doWhere + doWhat, function () {
                $('#pos' + doWhere).val(axisVal);
                $tooQuick = false;
            }, null);
        });

        $(document).ready(function() {
            $("#dropzone").appendTo("#newDropzone").show();
            $("#tempChart").appendTo("#newTempChart").show();
        });

        $(document).ready(function() {
            $(function() {
                var data = [];
                var data2 = [];
                var totalPoints = 300;

                function getData() {
                    data = data.slice(1);
                    while (data.length < totalPoints) {
                        var x = new Date($.now());
                        var y = $extruderTemp;
                        data.push(y);
                    }
                    var res = [];
                    for (var i = 0; i < data.length; ++i) {
                        res.push([i, data[i]]);
                    }
                    return res;
                }

                function getData2() {
                    data2 = data2.slice(1);
                    while (data2.length < totalPoints) {
                        var x = new Date($.now());
                        var y = $bedTemp;
                        data2.push(y);
                    }
                    var res2 = [];
                    for (var i = 0; i < data2.length; ++i) {
                        res2.push([i, data2[i]]);
                    }
                    return res2;
                }

                // Set up the control widget
                var updateInterval = 500;
                var plot = $.plot("#tempChart", [getData()], {
                    series: {
                        shadowSize: 0 // Drawing is faster without shadows
                    },
                    colors: ['#ff0000'],
                    yaxis: {
                        min: 0,
                        max: 300,
                    },
                    xaxis: {
                        show: false
                    },
                    zoom: {
                        interactive: false
                    },
                    pan: {
                        interactive: true
                    }
                });

                var plot2 = $.plot("#tempChart2", [getData2()], {
                    series: {
                        shadowSize: 0 // Drawing is faster without shadows
                    },
                    colors: ['#0037ff'],
                    yaxis: {
                        min: 0,
                        max: 120,
                    },
                    xaxis: {
                        show: false
                    },
                    zoom: {
                        interactive: false
                    },
                    pan: {
                        interactive: true
                    }

                });

                var tempChart = $("#tempChart");
                var tempChart2 = $("#tempChart2");

                function update() {
                    plot.setData([getData()]);
                    plot2.setData([getData2()]);
                    // Since the axes don't change, we don't need to call plot.setupGrid()
                    plot.draw();
                    plot2.draw();
                    setTimeout(update, updateInterval);
                }

                update();
            });

        });

        $(function() {
            $("#fanSlider").slider({
                orientation: 'vertical',
                value: 0,
                min: 0,
                max: 255,
                step: 25.5,
                slide: function(event, ui) {
                    var fanPercent = ui.value;
                    setFan(ui.value);
                    var fanMax = 255;
                    fanPercent = (fanPercent / fanMax) * 100;
                    if (fanPercent == '0') {
                        fanPercent = "Off";
                    } else {
                        fanPercent = fanPercent + "%";
                    }
                    $("#fanAmount").html(fanPercent);
                }
            });
        });
    </script>
</body>

</html>